<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Store Location Submission</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #71b7e6, #9b59b6); /* Gradient Background */
            color: #333;
            overflow-x: hidden;
        }

        /* Container for the form */
        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-sizing: border-box;
        }

        h1 {
            color: #34495e;
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 700;
        }

        /* Form Elements */
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            text-align: left;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            color: #333;
            background-color: #f8f8f8;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: #71b7e6;
            box-shadow: 0 0 8px rgba(113, 183, 230, 0.3);
            outline: none;
        }

        button {
            background-color: #28a745; /* Green submit button */
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }

        button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: translateY(0);
        }

        /* Status & Info Display */
        #status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 1em;
            background-color: #e0f7fa;
            color: #00796b;
            text-align: center;
        }

        #status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .coords-display {
            margin-top: 15px;
            text-align: left;
            font-size: 0.95em;
            color: #666;
        }

        .coords-display span {
            font-weight: 600;
            color: #444;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                margin: 20px;
                padding: 25px 30px;
            }
            h1 {
                font-size: 1.8em;
            }
            button {
                font-size: 1em;
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üõí Store Location Submission</h1>
        
        <form id="locationForm">
            
            <label for="division">Select Division:</label>
            <select id="division" required>
                <option value="">-- Select Division --</option>
            </select>

            <label for="asm">Select ASM:</label>
            <select id="asm" required>
                <option value="">-- Select ASM --</option>
            </select>

            <label for="area">Select Area:</label>
            <select id="area" required>
                <option value="">-- Select Area --</option>
            </select>
            
            <label for="storeName">Enter Store Name:</label>
            <input type="text" id="storeName" placeholder="Type Store Name Here" required>
            
            <div id="status">Click 'Submit' to get location...</div>

            <button type="submit" id="submitBtn">Get Location & Submit to Google Sheet</button>

            <div class="coords-display">
                <p>Latitude: <span id="displayLat">...</span></p>
                <p>Longitude: <span id="displayLon">...</span></p>
            </div>

        </form>
    </div>

    <script>
        // *************************************************************************
        // ‚ö†Ô∏è CRITICAL: Paste your Google Apps Script Web App URL here
        // *************************************************************************
        const WEB_APP_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE'; 
        // *************************************************************************

        // Hierarchy Data (Populated from your shared image)
        const hierarchyData = {
            "FBRM CENTRAL": {
                "ASM GUJRANWALA": ["GUJRANWALA A", "GUJRANWALA B", "GUJRANWALA C"],
                "ASM LAHORE D": ["LAHORE D/F", "LAHORE D/C", "LAHORE CANTT"],
                "ASM MULTAN": ["MULTAN A", "MULTAN B", "MULTAN C", "MULTAN D"],
                "ASM FAISALABAD": ["FSD A", "FSD B", "FSD C"],
                "ASM SIALKOT": ["SIALKOT A", "SIALKOT B"],
                "ASM SHEIKHUPURA": ["SHEIKHUPURA A", "SHEIKHUPURA B"],
                "ASM SAHIWAL": ["SAHIWAL A", "SAHIWAL B"],
                "ASM BAHAWALPUR": ["BWP A", "BWP B"],
                "ASM RAHIM YAR KHAN": ["RYK A", "RYK B"],
                "ASM ATTOCK": ["ATTOCK A"],
                "ASM DG KHAN": ["DG KHAN A"],
                "ASM JHELUM": ["JHELUM A"],
                "ASM JHANG": ["JHANG A"],
                "ASM KASUR": ["KASUR A"],
                "ASM KHANEWAL": ["KHANEWAL A"],
                "ASM MIANWALI": ["MIANWALI A"],
                "ASM MUZAFFARGARH": ["MUZAFFARGARH A"],
                "ASM OKARA": ["OKARA A"],
                "ASM SAIDPUR": ["SAIDPUR A"],
                "ASM SARGODHA": ["SARGODHA A", "SARGODHA B"],
                "ASM TAXILA": ["TAXILA A"],
                "ASM TOBA TEK SINGH": ["TTS A"],
                "ASM VEHARI": ["VEHARI A"]
            },
            "FBRM NORTH": {
                "ASM RAWALPINDI": ["RWP A", "RWP B", "RWP C", "RWP D"],
                "ASM PESHAWAR": ["PESHAWAR A", "PESHAWAR B", "PESHAWAR C"],
                "ASM ISLAMABAD": ["ISLAMABAD A", "ISLAMABAD B"],
                "ASM ABBOTTABAD": ["ABBOTTABAD A"],
                "ASM BUNER": ["BUNER A"],
                "ASM CHAKWAL": ["CHAKWAL A"],
                "ASM DIR LOWER": ["DIR L A"],
                "ASM SWAT": ["SWAT A"],
                "ASM KOHAT": ["KOHAT A"],
                "ASM MARDAN": ["MARDAN A"],
                "ASM NOWSHERA": ["NOWSHERA A"],
                "ASM SAWABI": ["SWABI A"],
                "ASM WAHP CANTT": ["WAHC A"],
                "ASM BANNU": ["BANNU A"],
                "ASM DERA ISMAIL KHAN": ["DIK A"],
                "ASM HARIPUR": ["HARIPUR A"],
                "ASM KHARIAN": ["KHARIAN A"],
                "ASM MANSEHRA": ["MANSEHRA A"],
                "ASM MINGORA": ["MINGORA A"],
                "ASM PARACHINAR": ["PARACHINAR A"],
                "ASM SAKKARDU": ["SKD A"],
                "ASM GILGIT": ["GILGIT A"],
                "ASM MUZZAFARABAD": ["MUZAF A"],
                "ASM MIRPUR": ["MIRPUR A"],
                "ASM BAGH": ["BAGH A"]
            },
            "FBRM SOUTH": {
                "ASM KARACHI F": ["KHI F"],
                "ASM KARACHI C": ["KHI C", "KHI C/B"],
                "ASM HYDERABAD": ["HYD A", "HYD B"],
                "ASM SUKKUR": ["SUKKUR A"],
                "ASM QUETTA": ["QUETTA A"],
                "ASM LARKANA": ["LARKANA A"],
                "ASM NAWABSHAH": ["NWB A"],
                "ASM CHAMAN": ["CHAMAN A"]
            }
            // Add your complete hierarchy data here
        };

        const divisionSelect = document.getElementById('division');
        const asmSelect = document.getElementById('asm');
        const areaSelect = document.getElementById('area');
        const locationForm = document.getElementById('locationForm');
        const statusText = document.getElementById('status');
        const submitBtn = document.getElementById('submitBtn');
        const displayLat = document.getElementById('displayLat');
        const displayLon = document.getElementById('displayLon');


        // ---------------------------------------------------
        // I. Hierarchy Selectors Population Functions
        // ---------------------------------------------------

        function populateDivisions() {
            // Populate Divisions
            for (const division in hierarchyData) {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionSelect.appendChild(option);
            }
        }

        function populateASMs() {
            asmSelect.innerHTML = '<option value="">-- Select ASM --</option>'; 
            areaSelect.innerHTML = '<option value="">-- Select Area --</option>'; 
            
            const selectedDivision = divisionSelect.value;
            if (selectedDivision && hierarchyData[selectedDivision]) {
                for (const asm in hierarchyData[selectedDivision]) {
                    const option = document.createElement('option');
                    option.value = asm;
                    option.textContent = asm;
                    asmSelect.appendChild(option);
                }
            }
        }

        function populateAreas() {
            areaSelect.innerHTML = '<option value="">-- Select Area --</option>'; 

            const selectedDivision = divisionSelect.value;
            const selectedASM = asmSelect.value;
            
            if (selectedDivision && selectedASM && hierarchyData[selectedDivision][selectedASM]) {
                hierarchyData[selectedDivision][selectedASM].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
            }
        }
        
        // Event Listeners for cascading dropdowns
        divisionSelect.addEventListener('change', populateASMs);
        asmSelect.addEventListener('change', populateAreas);

        // Initial load
        populateDivisions();
        
        // ---------------------------------------------------
        // II. Geolocation and Data Submission Logic
        // ---------------------------------------------------

        locationForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            // 1. Check if all fields are filled
            if (!divisionSelect.value || !asmSelect.value || !areaSelect.value || !document.getElementById('storeName').value) {
                statusText.textContent = '‚ùå Please fill all fields (Division, ASM, Area, and Store Name).';
                statusText.classList.add('error');
                return;
            }

            // 2. Start Geolocation
            if ("geolocation" in navigator) {
                statusText.textContent = 'Requesting location... (Please allow location access).';
                statusText.classList.remove('error');
                submitBtn.disabled = true; 

                navigator.geolocation.getCurrentPosition(
                    // Success Function
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        // Accuracy check (if accuracy is poor, warn the user)
                        if (accuracy > 30) {
                            statusText.textContent = `‚ö†Ô∏è Location found, but accuracy is low (${Math.round(accuracy)}m). Try waiting outside or refresh and try again.`;
                            statusText.classList.add('error');
                            submitBtn.disabled = false;
                            return;
                        }

                        displayLat.textContent = lat;
                        displayLon.textContent = lon;
                        statusText.textContent = `‚úÖ Location acquired: Accuracy ${Math.round(accuracy)}m. Submitting data...`;
                        statusText.classList.remove('error');

                        // 3. Submit Data to Google Sheet
                        const payload = {
                            division: divisionSelect.value, 
                            asm: asmSelect.value, 
                            area: areaSelect.value, 
                            storeName: document.getElementById('storeName').value,
                            latitude: lat,
                            longitude: lon
                        };

                        fetch(WEB_APP_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain;charset=utf-8', 
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'SUCCESS') {
                                statusText.textContent = `ü•≥ Success! Data for '${payload.storeName}' saved to Google Sheet.`;
                                statusText.classList.remove('error');
                                // Reset form and dropdowns
                                locationForm.reset();
                                displayLat.textContent = '...';
                                displayLon.textContent = '...';
                                populateASMs(); 
                                populateAreas(); 
                            } else {
                                statusText.textContent = `‚ùå Error: Could not save data. (${data.message || 'Unknown error'})`;
                                statusText.classList.add('error');
                            }
                            submitBtn.disabled = false;
                        })
                        .catch((error) => {
                            statusText.textContent = `‚ùå Communication Error: Check Web App URL or internet connection.`;
                            statusText.classList.add('error');
                            console.error('Fetch error:', error);
                            submitBtn.disabled = false;
                        });
                        
                    },
                    
                    // Error Function
                    (error) => {
                        submitBtn.disabled = false;
                        let errorMessage = 'Could not get location.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "‚ùå Permission Denied. Please allow location access in your browser settings.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "‚ùå Location information unavailable. Check GPS/Internet connection.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "‚ùå Timed out waiting for location. Please try again.";
                        }
                        statusText.textContent = errorMessage;
                        statusText.classList.add('error');
                    },
                    
                    // Options for high accuracy
                    {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    }
                );
                
            } else {
                statusText.textContent = "‚ùå Your browser does not support Geolocation.";
                statusText.classList.add('error');
            }
        });
    </script> 
</body>
</html>
